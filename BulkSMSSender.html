<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel File Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .file-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .file-input-button:hover {
            background: #3367d6;
        }
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .filters-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        .sms-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 5px;
            border: 1px solid #b3d7ff;
        }
        .sms-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .sms-control-group {
            flex: 1;
            min-width: 200px;
        }
        .sms-control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .sms-control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .sms-control-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: Arial, sans-serif;
        }
        .template-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            min-height: 60px;
            white-space: pre-wrap;
        }
        .filter-controls {
            margin-bottom: 15px;
        }
        .filter-group {
            display: inline-block;
            margin: 8px;
            vertical-align: top;
        }
        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .filter-group select {
            min-width: 120px;
            max-width: 200px;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #218838;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        button.export {
            background: #17a2b8;
        }
        button.export:hover {
            background: #138496;
        }
        button.sms {
            background: #fd7e14;
        }
        button.sms:hover {
            background: #e8670e;
        }
        select, input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f8ff;
        }
        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        .sms-table-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #cce8ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        .data-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .search-box {
            margin: 10px 5px;
            padding: 8px;
            width: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state h3 {
            color: #999;
        }
        .text-cell {
            max-width: 300px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .additional-numbers-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Excel File Viewer & Filter</h1>
        
        <div class="file-section">
            <h3>Select Excel File</h3>
            <p>Choose an Excel file (.xlsx or .xls) from your computer</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" />
                <div class="file-input-button">
                    üìÅ Choose Excel File
                </div>
            </div>
            <div id="fileInfo" style="display: none;"></div>
        </div>

        <div class="filters-section" style="display:none;" id="filtersSection">
            <h3>üîç Filter Data</h3>
            <div class="filter-controls">
                <input type="text" id="searchBox" class="search-box" placeholder="Search across all columns..." />
                <div id="filterControls"></div>
            </div>
            <div>
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="clearFilters()" class="secondary">Clear All</button>
                <button onclick="exportFilteredData()" class="export">Export Filtered Data</button>
            </div>
        </div>

        <div id="dataSection" style="display:none;">
            <h3>üìã Spreadsheet Data</h3>
            <div id="dataInfo" class="data-info"></div>
            <div class="table-container">
                <table id="dataTable"></table>
            </div>
        </div>

        <div class="sms-section" style="display:none;" id="smsSection">
            <h3>üì± SMS Send Options</h3>
            <div class="sms-controls">
                <div class="sms-control-group">
                    <label for="fromSelect">From</label>
                    <select id="fromSelect">
                        <option value="">Select From...</option>
                        <option value="61482081416">61482081416</option>
                        <option value="Advertiser">Advertiser</option>
                        <option value="CairnsPost">CairnsPost</option>
                        <option value="Chronicle">Chronicle</option>
                        <option value="CourierMail">CourierMail</option>
                        <option value="Daily Tele">Daily Tele</option>
                        <option value="GCBulletin">GCBulletin</option>
                        <option value="GeelongAddy">GeelongAddy</option>
                        <option value="Herald Sun">Herald Sun</option>
                        <option value="NT News">NT News</option>
                        <option value="The Aus">The Aus</option>
                        <option value="The Mercury">The Mercury</option>
                        <option value="TVBulletin">TVBulletin</option>
                        <option value="WeeklyTimes">WeeklyTimes</option>
                    </select>
                </div>
                <div class="sms-control-group">
                    <label for="templateSelect">SMS Template</label>
                    <select id="templateSelect">
                        <option value="">Select Template...</option>
                    </select>
                </div>
                <div class="sms-control-group">
                    <label for="additionalNumbers">Additional To Numbers</label>
                    <textarea id="additionalNumbers" placeholder="Enter additional mobile numbers (one per line)&#10;Example:&#10;0412345678&#10;0498765432"></textarea>
                    <div class="additional-numbers-info">
                        Enter additional mobile numbers to include in the SMS send (one per line)
                    </div>
                </div>
            </div>
            <div class="template-preview" id="templatePreview">
                Select a template to preview the SMS text...
            </div>
            <div style="margin-top: 15px;">
                <button onclick="generateSMSTable()" class="sms">Generate SMS Table</button>
                <button onclick="exportSMSData()" class="export">Export SMS Data</button>
            </div>
            <div class="sms-table-container" id="smsTableContainer" style="display: none;">
                <table id="smsTable"></table>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <script>
        let originalData = [];
        let filteredData = [];
        let headers = [];
        let currentFileName = '';
        let mobileColumnIndex = -1;

        // SMS Templates data
        const smsTemplates = {
            "NCS Proactive - Mount Gambier": "We apologise for the late delivery of your newspaper today due to unexpected vehicle issues with our distributor in your area.  An extension has been added to your subscription.",
            "NCS Proactive Mon-Sat DPE - Cairns Post": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.cairnspost.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - CM": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.couriermail.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - DT": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.dailytelegraph.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - GAD": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.geelongadvertiser.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - GCB": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.goldcoastbulletin.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - Generic (NO DPE LINK)": "We're sorry for an unexpected delay to your newspaper delivery this morning.  No action required, we will get your paper to you as early as possible.",
            "NCS Proactive Mon-Sat DPE - HS": "Unfortunately we won't be able to deliver today's paper.  An extension to your subscription has been applied.  To read the digital version of the paper, visit www.heraldsun.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - NTN": "Due to production issues your paper will not be delivered today. An extension will be applied to your subscription and we'll attempt to deliver today's edition on Saturday. Today's Digital Paper has been unlocked for you to read online, please visit www.ntnews.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - TC": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.thechronicle.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - TM": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.themercury.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - WT": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.weeklytimesnow.com.au/digitalprinteditions",
            "NCS Proactive Sat- TAUS": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online https://www.theaustralian.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - AA": "We're sorry for some minor delays to your newspaper delivery today. While you wait, read today's paper online www.adelaidenow.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - Cairns Post": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.couriermail.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - CM": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.couriermail.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - DT": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.dailytelegraph.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - GAD": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.heraldsun.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - GCB": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.couriermail.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - Generic (NO DPE LINK)": "We're sorry for an unexpected delay to your newspaper delivery today.  No action required, we will get your paper to you as early as possible.",
            "NCS Proactive Sunday DPE - HS": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.heraldsun.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - NTN": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.ntnews.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - TC": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.thechronicle.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - TM": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.themercury.com.au/digitalprinteditions",
            "NCS Proactive Sunday DPE - TVB": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online www.townsvillebulletin.com.au/digitalprinteditions",
            "NCS Proactive Mon-Sat DPE - Test": "We're sorry for the delay to your newspaper delivery today. While you wait, read today's paper online"
        };

        // File input handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            showStatus('Loading file...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length > 0) {
                        headers = jsonData[0].map(header => header || 'Column');
                        originalData = jsonData.slice(1).filter(row => 
                            row.some(cell => cell !== null && cell !== undefined && cell !== '')
                        );
                        filteredData = [...originalData];
                        
                        // Find mobile column
                        findMobileColumn();
                        
                        displayFile();
                        displayData();
                        createFilterControls();
                        setupSMSSection();
                        
                        document.getElementById('filtersSection').style.display = 'block';
                        document.getElementById('dataSection').style.display = 'block';
                        document.getElementById('smsSection').style.display = 'block';
                        
                        showStatus(`Successfully loaded "$${file.name}" with $${originalData.length} rows and ${headers.length} columns`, 'success');
                    } else {
                        showStatus('The selected file appears to be empty', 'error');
                    }
                } catch (error) {
                    showStatus('Error reading file: ' + error.message, 'error');
                    console.error('File reading error:', error);
                }
            };
            
            reader.onerror = function() {
                showStatus('Error reading file', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function findMobileColumn() {
            mobileColumnIndex = headers.findIndex(header => 
                header.toLowerCase().includes('mobile') || 
                header.toLowerCase().includes('phone') ||
                header.toLowerCase().includes('number')
            );
            
            if (mobileColumnIndex === -1) {
                showStatus('Warning: No mobile/phone column detected. You can still use additional numbers.', 'error');
            }
        }

        function setupSMSSection() {
            // Populate template dropdown
            const templateSelect = document.getElementById('templateSelect');
            templateSelect.innerHTML = '<option value="">Select Template...</option>';
            
            Object.keys(smsTemplates).forEach(templateName => {
                const option = document.createElement('option');
                option.value = templateName;
                option.textContent = templateName;
                templateSelect.appendChild(option);
            });

            // Add event listeners
            document.getElementById('templateSelect').addEventListener('change', updateTemplatePreview);
            document.getElementById('fromSelect').addEventListener('change', function() {
                if (document.getElementById('templateSelect').value) {
                    generateSMSTable();
                }
            });
            document.getElementById('additionalNumbers').addEventListener('input', function() {
                const fromValue = document.getElementById('fromSelect').value;
                const templateValue = document.getElementById('templateSelect').value;
                if (fromValue && templateValue) {
                    generateSMSTable();
                }
            });
        }

        function updateTemplatePreview() {
            const templateName = document.getElementById('templateSelect').value;
            const preview = document.getElementById('templatePreview');
            
            if (templateName && smsTemplates[templateName]) {
                preview.textContent = smsTemplates[templateName];
                preview.style.color = '#333';
            } else {
                preview.textContent = 'Select a template to preview the SMS text...';
                preview.style.color = '#666';
            }
        }

        function getAdditionalNumbers() {
            const additionalText = document.getElementById('additionalNumbers').value.trim();
            if (!additionalText) return [];
            
            return additionalText
                .split('\n')
                .map(number => number.trim())
                .filter(number => number && number.length > 0);
        }

        function generateSMSTable() {
            const fromValue = document.getElementById('fromSelect').value;
            const templateName = document.getElementById('templateSelect').value;
            
            if (!fromValue) {
                showStatus('Please select a "From" value', 'error');
                return;
            }
            
            if (!templateName) {
                showStatus('Please select an SMS template', 'error');
                return;
            }

            const templateText = smsTemplates[templateName];
            const smsTable = document.getElementById('smsTable');
            const smsTableContainer = document.getElementById('smsTableContainer');
            
            // Create table header
            let html = '<thead><tr><th>From</th><th>To</th><th>Text</th><th>Source</th></tr></thead><tbody>';
            
            let totalRecipients = 0;
            
            // Add rows for spreadsheet data if mobile column exists
            if (mobileColumnIndex >= 0 && filteredData.length > 0) {
                filteredData.forEach(row => {
                    const mobileNumber = row[mobileColumnIndex];
                    if (mobileNumber && mobileNumber.toString().trim()) {
                        html += `
                            <tr>
                                <td>${fromValue}</td>
                                <td>${mobileNumber}</td>
                                <td class="text-cell">${templateText}</td>
                                <td>Spreadsheet</td>
                            </tr>
                        `;
                        totalRecipients++;
                    }
                });
            }
            
            // Add rows for additional numbers
            const additionalNumbers = getAdditionalNumbers();
            additionalNumbers.forEach(number => {
                html += `
                    <tr>
                        <td>${fromValue}</td>
                        <td>${number}</td>
                        <td class="text-cell">${templateText}</td>
                        <td>Additional</td>
                    </tr>
                `;
                totalRecipients++;
            });
            
            html += '</tbody>';
            smsTable.innerHTML = html;
            smsTableContainer.style.display = 'block';
            
            if (totalRecipients === 0) {
                showStatus('No recipients found. Add mobile numbers to spreadsheet or additional numbers list.', 'error');
            } else {
                const spreadsheetCount = mobileColumnIndex >= 0 ? filteredData.filter(row => 
                    row[mobileColumnIndex] && row[mobileColumnIndex].toString().trim()
                ).length : 0;
                const additionalCount = additionalNumbers.length;
                
                showStatus(`Generated SMS table with $${totalRecipients} total recipients ($${spreadsheetCount} from spreadsheet, ${additionalCount} additional)`, 'success');
            }
        }

        function exportSMSData() {
            const smsTable = document.getElementById('smsTable');
            if (!smsTable.innerHTML.includes('tbody')) {
                showStatus('Generate SMS table first before exporting', 'error');
                return;
            }

            const fromValue = document.getElementById('fromSelect').value;
            const templateName = document.getElementById('templateSelect').value;
            const templateText = smsTemplates[templateName];
            
            // Create data array for export
            const exportData = [['From', 'To', 'Text', 'Source']];
            
            // Add spreadsheet data
            if (mobileColumnIndex >= 0) {
                filteredData.forEach(row => {
                    const mobileNumber = row[mobileColumnIndex];
                    if (mobileNumber && mobileNumber.toString().trim()) {
                        exportData.push([fromValue, mobileNumber, templateText, 'Spreadsheet']);
                    }
                });
            }
            
            // Add additional numbers
            const additionalNumbers = getAdditionalNumbers();
            additionalNumbers.forEach(number => {
                exportData.push([fromValue, number, templateText, 'Additional']);
            });
            
            if (exportData.length <= 1) {
                showStatus('No SMS data to export', 'error');
                return;
            }
            
            try {
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'SMS Data');
                
                const fileName = `SMS_Export_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus(`Exported $${exportData.length - 1} SMS records to "$${fileName}"`, 'success');
            } catch (error) {
                showStatus('Error exporting SMS data: ' + error.message, 'error');
            }
        }

        function displayFile() {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <div class="file-info">
                    <strong>üìÑ ${currentFileName}</strong><br>
                    <small>File loaded successfully</small>
                </div>
            `;
            fileInfo.style.display = 'block';
        }

        function displayData() {
            const table = document.getElementById('dataTable');
            const dataInfo = document.getElementById('dataInfo');
            
            // Update info
            dataInfo.innerHTML = `
                <strong>Total Rows:</strong> ${originalData.length} | 
                <strong>Showing:</strong> ${filteredData.length} rows | 
                <strong>Columns:</strong> ${headers.length}
                $${mobileColumnIndex >= 0 ? ` | <strong>Mobile Column:</strong> $${headers[mobileColumnIndex]}` : ''}
            `;
            
            // Create table
            if (filteredData.length === 0) {
                table.innerHTML = `
                    <div class="empty-state">
                        <h3>No data matches your filters</h3>
                        <p>Try adjusting your filter criteria</p>
                    </div>
                `;
                return;
            }

            let html = '<thead><tr>';
            headers.forEach((header, index) => {
                const isMobileColumn = index === mobileColumnIndex;
                html += `<th>$${header} <small>(Col $${index + 1})</small>${isMobileColumn ? ' üì±' : ''}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            filteredData.forEach((row, rowIndex) => {
                html += '<tr>';
                headers.forEach((_, colIndex) => {
                    const cellValue = row[colIndex];
                    const displayValue = cellValue !== null && cellValue !== undefined ? cellValue : '';
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function createFilterControls() {
            const filterControls = document.getElementById('filterControls');
            filterControls.innerHTML = '';
            
            headers.forEach((header, index) => {
                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                
                const label = document.createElement('label');
                label.textContent = header;
                
                const select = document.createElement('select');
                select.id = `filter-${index}`;
                select.innerHTML = '<option value="">All values</option>';
                
                // Get unique values for this column
                const uniqueValues = [...new Set(
                    originalData
                        .map(row => row[index])
                        .filter(val => val !== null && val !== undefined && val !== '')
                )];
                
                uniqueValues.sort((a, b) => {
                    if (typeof a === 'string' && typeof b === 'string') {
                        return a.localeCompare(b);
                    }
                    return a < b ? -1 : a > b ? 1 : 0;
                });
                
                uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = String(value).length > 30 ? 
                        String(value).substring(0, 30) + '...' : value;
                    select.appendChild(option);
                });
                
                filterGroup.appendChild(label);
                filterGroup.appendChild(select);
                filterControls.appendChild(filterGroup);
            });

            // Add search box functionality
            document.getElementById('searchBox').addEventListener('input', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            filteredData = originalData.filter(row => {
                // Apply column filters
                const columnMatch = headers.every((header, index) => {
                    const filterSelect = document.getElementById(`filter-${index}`);
                    const filterValue = filterSelect ? filterSelect.value : '';
                    return !filterValue || String(row[index]) === filterValue;
                });
                
                // Apply search filter
                const searchMatch = !searchTerm || row.some(cell => 
                    String(cell || '').toLowerCase().includes(searchTerm)
                );
                
                return columnMatch && searchMatch;
            });
            
            displayData();
            showStatus(`Showing ${filteredData.length} of ${originalData.length} rows`, 'info');
            
            // Auto-regenerate SMS table if both dropdowns are selected
            const fromValue = document.getElementById('fromSelect').value;
            const templateValue = document.getElementById('templateSelect').value;
            if (fromValue && templateValue) {
                generateSMSTable();
            }
        }

        function clearFilters() {
            // Clear column filters
            headers.forEach((header, index) => {
                const filterSelect = document.getElementById(`filter-${index}`);
                if (filterSelect) filterSelect.value = '';
            });
            
            // Clear search box
            document.getElementById('searchBox').value = '';
            
            filteredData = [...originalData];
            displayData();
            showStatus('All filters cleared', 'success');
            
            // Auto-regenerate SMS table if both dropdowns are selected
            const fromValue = document.getElementById('fromSelect').value;
            const templateValue = document.getElementById('templateSelect').value;
            if (fromValue && templateValue) {
                generateSMSTable();
            }
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                showStatus('No data to export', 'error');
                return;
            }
            
            try {
                const ws = XLSX.utils.aoa_to_sheet([headers, ...filteredData]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data');
                
                const fileName = currentFileName.replace(/\.[^/.]+$/, '') + '_filtered.xlsx';
                XLSX.writeFile(wb, fileName);
                
                showStatus(`Exported ${filteredData.length} rows to "${fileName}"`, 'success');
            } catch (error) {
                showStatus('Error exporting data: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Initialize
        window.onload = function() {
            showStatus('Welcome! Select an Excel file to get started.', 'info');
        };
    </script>
</body>
</html>
